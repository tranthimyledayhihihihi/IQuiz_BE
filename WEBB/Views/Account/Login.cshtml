@model WEBB.Models.Account.LoginViewModel
@{
    ViewBag.Title = "Đăng nhập";
}

<h2>@ViewBag.Title</h2>
<hr />

<div class="row">
    <div class="col-md-6">
        <form id="loginForm">

            @* BẮT BUỘC có để chống CSRF khi gọi SetAuthCookie *@
            @Html.AntiForgeryToken()

            <div class="form-group">
                @Html.LabelFor(m => m.TenDangNhap, new { @class = "control-label" })
                @Html.TextBoxFor(m => m.TenDangNhap, new { @class = "form-control" })
                @Html.ValidationMessageFor(m => m.TenDangNhap, "", new { @class = "text-danger" })
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.MatKhau, new { @class = "control-label" })
                @Html.PasswordFor(m => m.MatKhau, new { @class = "form-control" })
                @Html.ValidationMessageFor(m => m.MatKhau, "", new { @class = "text-danger" })
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">Đăng nhập</button>
            </div>

            <div id="api-error-message" class="text-danger" style="margin-top: 15px;"></div>
        </form>
        <p style="margin-top: 10px;">
            Chưa có tài khoản? @Html.ActionLink("Đăng ký ngay", "Register")
        </p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // URL Backend API
            var apiBaseUrl = "https://localhost:7092";

            $("#loginForm").submit(function (event) {
                event.preventDefault();

                var tenDangNhap = $("#TenDangNhap").val();
                var matKhau = $("#MatKhau").val();

                // 1. GỌI API ĐĂNG NHẬP (Lấy Token)
                $.ajax({
                    url: apiBaseUrl + "/api/account/login",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        tenDangNhap: tenDangNhap,
                        matKhau: matKhau
                    }),

                    success: function (response) {

                        var token = response.token;
                        localStorage.setItem("jwtToken", token);
                        localStorage.setItem("userName", response.tenNguoiDung);

                        // 2. GỌI CONTROLLER C# ĐỂ TẠO COOKIE (Cầu nối)
                        $.ajax({
                            url: "@Url.Action("SetAuthCookie", "Account")",
                            type: "POST",
                            data: {
                                // Lấy anti-forgery token từ form
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                                token: token // Gửi JWT token lên
                            },
                            success: function(cookieResponse) {
                                if(cookieResponse.success) {
                                    alert("Đăng nhập thành công!");

                                    // 3. KIỂM TRA QUYỀN ĐỂ CHUYỂN HƯỚNG
                                    if (tenDangNhap.toLowerCase() === 'admin') {
                                        // Chuyển hướng sang Dashboard Admin
                                        window.location.href = "@Url.Action("Index", "Admin")";
                                    } else {
                                        // Chuyển hướng sang Trang chủ Người dùng
                                        window.location.href = "@Url.Action("Index", "Home")";
                                    }
                                } else {
                                    $("#api-error-message").text("Lỗi tạo cookie: " + cookieResponse.message);
                                }
                            },
                            error: function() {
                                $("#api-error-message").text("Lỗi nghiêm trọng khi gọi SetAuthCookie.");
                            }
                        });
                    },

                    // 4. XỬ LÝ KHI API THẤT BẠI
                    error: function (jqXHR) {
                        var errorMessage = "Lỗi không xác định.";
                        if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                            errorMessage = jqXHR.responseJSON.message;
                        } else if (jqXHR.status == 401) {
                            errorMessage = "Tên đăng nhập hoặc mật khẩu không đúng.";
                        } else if (jqXHR.status == 0) {
                            errorMessage = "Không thể kết nối đến API. Hãy chắc chắn API đang chạy!";
                        }
                        $("#api-error-message").text(errorMessage);
                    }
                });
            });
        });
    </script>
}