@{
    ViewBag.Title = "Báo cáo & Thống kê";
}
@model WEBB.Models.Admin.BaoCaoRequestModel

<h2>Xuất Báo cáo</h2>
<p>Chọn loại báo cáo bạn muốn xem.</p>

<div class="row">
    <div class="col-md-6">
        <form id="report-form">
            <div class="form-group">
                @Html.LabelFor(m => m.LoaiBaoCao)
                @Html.DropDownListFor(m => m.LoaiBaoCao, new SelectList(
                    new[] {
                        new { Value = "nguoidung", Text = "Báo cáo Người dùng" },
                        new { Value = "ketqua", Text = "Báo cáo Kết quả chơi" },
                    }, "Value", "Text"
                ), "--- Chọn loại báo cáo ---", new { @class = "form-control" })
            </div>
            <div class="form-group">
                @Html.LabelFor(m => m.NgayBatDau)
                @Html.TextBoxFor(m => m.NgayBatDau, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
            </div>
            <div class="form-group">
                @Html.LabelFor(m => m.NgayKetThuc)
                @Html.TextBoxFor(m => m.NgayKetThuc, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
            </div>
            <button type="submit" class="btn btn-success">Xem Báo cáo</button>
        </form>
    </div>
</div>
<hr />
<h3>Kết quả (Raw JSON)</h3>
<pre>
<code id="report-results">
        Chưa có dữ liệu...
    </code>
</pre>

@section Scripts {
    <script>
    $(document).ready(function () {
        var apiBaseUrl = "https://localhost:7092";
        var token = localStorage.getItem("jwtToken");
        function getApiHeaders() { /* ... (Copy hàm) ... */ }
        function handleApiError(jqXHR) { /* ... (Copy hàm) ... */ }

        $("#report-form").submit(function (event) {
            event.preventDefault();
            $("#report-results").text("Đang tải...");

            var requestData = {
                loaiBaoCao: $("#LoaiBaoCao").val(),
                ngayBatDau: $("#NgayBatDau").val() || null,
                ngayKetThuc: $("#NgayKetThuc").val() || null
            };

            $.ajax({
                url: apiBaseUrl + "/api/baocao/export",
                type: "POST",
                headers: getApiHeaders(true),
                data: JSON.stringify(requestData),
                success: function (response) {
                    // Hiển thị JSON cho đẹp
                    var jsonString = JSON.stringify(response, null, 2);
                    $("#report-results").text(jsonString);
                },
                error: handleApiError
            });
        });

        if (!token) { /* ... (Copy logic kiểm tra token) ... */ }
    });
    </script>
}