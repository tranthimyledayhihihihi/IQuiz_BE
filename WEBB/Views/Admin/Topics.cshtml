@{
    ViewBag.Title = "Quản lý Chủ đề";
}

<h2>Quản lý Chủ đề</h2>
<p>
    <button type="button" class="btn btn-primary" id="btn-add-new">
        + Thêm Chủ đề mới
    </button>
</p>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Tên Chủ đề</th>
            <th>Mô tả</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody id="topics-table-body">
    </tbody>
</table>

<div class="modal fade" id="topicModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="topic-form">
                <div class="modal-header">
                    <h4 class="modal-title" id="modal-title">Thêm Chủ đề mới</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="form-chude-id" />

                    <div class="form-group">
                        <label for="form-ten-chude">Tên Chủ đề</label>
                        <input type="text" class="form-control" id="form-ten-chude" required />
                    </div>
                    <div class="form-group">
                        <label for="form-mo-ta">Mô tả</label>
                        <textarea class="form-control" id="form-mo-ta" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="form-trang-thai" checked>
                                Trạng thái (Tích để Hiển thị)
                            </label>
                        </div>
                    </div>
                    <div id="modal-error-message" class="text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function () {
        // === KHAI BÁO BIẾN VÀ HÀM HELPER (Giống trang Index) ===
        var apiBaseUrl = "https://localhost:7092";
        var token = localStorage.getItem("jwtToken");

        function getApiHeaders() {
            return {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            };
        }

        function handleApiError(jqXHR) {
            if (jqXHR.status == 401 || jqXHR.status == 403) {
                alert("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.");
                localStorage.removeItem("jwtToken");
                window.location.href = "@Url.Action("Login", "Account")";
            } else {
                $("#modal-error-message").text(jqXHR.responseJSON?.message || "Lỗi không xác định.");
            }
        }

        // === LOGIC CHÍNH ===

        // 1. HÀM TẢI DỮ LIỆU (READ)
        function loadTopics() {
            $.ajax({
                url: apiBaseUrl + "/api/QLChuDe",
                type: "GET",
                headers: getApiHeaders(),
                success: function (response) {
                    var $tableBody = $("#topics-table-body");
                    $tableBody.empty(); // Xóa dữ liệu cũ

                    // Duyệt qua từng chủ đề và tạo 1 hàng <tr>
                    $.each(response, function (i, topic) {
                        var status = topic.trangThai ?
                            '<span class="label label-success">Đang Hiện</span>' :
                            '<span class="label label-default">Đang Ẩn</span>';

                        var row = '<tr>' +
                            '<td>' + topic.chuDeID + '</td>' +
                            '<td>' + topic.tenChuDe + '</td>' +
                            '<td>' + (topic.moTa || "") + '</td>' +
                            '<td>' + status + '</td>' +
                            '<td>' +
                                '<button class="btn btn-sm btn-info btn-edit" data-id="' + topic.chuDeID + '">Sửa</button> ' +
                                '<button class="btn btn-sm btn-danger btn-delete" data-id="' + topic.chuDeID + '">Xóa</button>' +
                            '</td>' +
                            '</tr>';
                        $tableBody.append(row);
                    });
                },
                error: handleApiError
            });
        }

        // 2. HÀM MỞ MODAL "THÊM MỚI" (CREATE - Step 1)
        $("#btn-add-new").click(function () {
            // Xóa sạch form
            $("#topic-form")[0].reset();
            $("#form-chude-id").val("");
            $("#form-trang-thai").prop("checked", true);
            $("#modal-error-message").text("");

            $("#modal-title").text("Thêm Chủ đề mới");
            $("#topicModal").modal("show");
        });

        // 3. HÀM GỬI FORM (CREATE - Step 2 / UPDATE - Step 2)
        $("#topic-form").submit(function (event) {
            event.preventDefault();

            var topicId = $("#form-chude-id").val();

            // Lấy dữ liệu từ form
            var topicData = {
                chuDeID: topicId ? parseInt(topicId) : 0,
                tenChuDe: $("#form-ten-chude").val(),
                moTa: $("#form-mo-ta").val(),
                trangThai: $("#form-trang-thai").is(":checked")
            };

            var isUpdating = topicId > 0;
            var apiUrl = isUpdating ? (apiBaseUrl + "/api/QLChuDe/" + topicId) : (apiBaseUrl + "/api/QLChuDe");
            var apiType = isUpdating ? "PUT" : "POST";

            $.ajax({
                url: apiUrl,
                type: apiType,
                headers: getApiHeaders(),
                data: JSON.stringify(topicData),
                success: function () {
                    $("#topicModal").modal("hide");
                    alert(isUpdating ? "Cập nhật thành công!" : "Thêm mới thành công!");
                    loadTopics(); // Tải lại bảng
                },
                error: handleApiError
            });
        });

        // 4. HÀM MỞ MODAL "SỬA" (UPDATE - Step 1)
        // (Dùng 'delegation' vì nút '.btn-edit' được tạo ra bởi AJAX)
        $("#topics-table-body").on("click", ".btn-edit", function () {
            var topicId = $(this).data("id");
            $("#modal-error-message").text("");

            // Gọi API /api/QLChuDe/{id} để lấy dữ liệu cũ
            $.ajax({
                url: apiBaseUrl + "/api/QLChuDe/" + topicId,
                type: "GET",
                headers: getApiHeaders(),
                success: function(topic) {
                    // Đổ dữ liệu vào form
                    $("#form-chude-id").val(topic.chuDeID);
                    $("#form-ten-chude").val(topic.tenChuDe);
                    $("#form-mo-ta").val(topic.moTa);
                    $("#form-trang-thai").prop("checked", topic.trangThai);

                    $("#modal-title").text("Cập nhật Chủ đề: " + topic.tenChuDe);
                    $("#topicModal").modal("show");
                },
                error: handleApiError
            });
        });

        // 5. HÀM XÓA (DELETE)
        $("#topics-table-body").on("click", ".btn-delete", function () {
            var topicId = $(this).data("id");

            if (confirm("Bạn có chắc muốn xóa chủ đề này? (ID: " + topicId + ")")) {
                $.ajax({
                    url: apiBaseUrl + "/api/QLChuDe/" + topicId,
                    type: "DELETE",
                    headers: getApiHeaders(),
                    success: function() {
                        alert("Xóa thành công!");
                        loadTopics(); // Tải lại bảng
                    },
                    error: handleApiError
                });
            }
        });

        // === CHẠY KHI TẢI TRANG ===
        if (!token) {
            window.location.href = "@Url.Action("Login", "Account")";
            return;
        }
        loadTopics(); // Tải danh sách chủ đề ngay khi vào trang
    });
    </script>
}