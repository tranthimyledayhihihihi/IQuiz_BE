@{
    ViewBag.Title = "Quản lý Người dùng";
}

<h2>Quản lý Người dùng</h2>
<p>Xem và quản lý các tài khoản trong hệ thống.</p>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Tên Đăng Nhập</th>
            <th>Họ Tên</th>
            <th>Email</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody id="users-table-body">
    </tbody>
</table>

@section Scripts {
    <script>
    $(document).ready(function () {
        var apiBaseUrl = "https://localhost:7092";
        var token = localStorage.getItem("jwtToken");

        function getApiHeaders(includeContentType = false) {
            var headers = { "Authorization": "Bearer " + token };
            if (includeContentType) {
                headers["Content-Type"] = "application/json";
            }
            return headers;
        }

        function handleApiError(jqXHR) { /* ... (Copy hàm handleApiError từ trên) ... */ }

        // 1. HÀM TẢI DỮ LIỆU (READ)
        function loadUsers() {
            $.ajax({
                url: apiBaseUrl + "/api/QLNguoiDung", // API Lấy User
                type: "GET",
                headers: getApiHeaders(),
                success: function (response) {
                    var $tableBody = $("#users-table-body");
                    $tableBody.empty();

                    // 'response.data' vì API này có phân trang
                    $.each(response.data, function (i, user) {
                        var status = user.trangThai ?
                            '<span class="label label-success">Hoạt động</span>' :
                            '<span class="label label-danger">Đã khóa</span>';

                        var buttonText = user.trangThai ? "Khóa (Ban)" : "Mở khóa";
                        var buttonClass = user.trangThai ? "btn-warning" : "btn-success";
                        var newStatus = !user.trangThai; // Giá trị mới sẽ gửi đi

                        var row = '<tr>' +
                            '<td>' + user.userID + '</td>' +
                            '<td>' + user.tenDangNhap + '</td>' +
                            '<td>' + (user.hoTen || "") + '</td>' +
                            '<td>' + (user.email || "") + '</td>' +
                            '<td>' + status + '</td>' +
                            '<td>' +
                                '<button class="btn btn-sm ' + buttonClass + ' btn-toggle-status" ' +
                                'data-id="' + user.userID + '" data-new-status="' + newStatus + '">' +
                                buttonText +
                                '</button>' +
                            '</td>' +
                            '</tr>';
                        $tableBody.append(row);
                    });
                },
                error: handleApiError
            });
        }

        // 2. HÀM KHÓA/MỞ KHÓA (UPDATE)
        $("#users-table-body").on("click", ".btn-toggle-status", function () {
            var userId = $(this).data("id");
            var newStatus = $(this).data("new-status");

            if (confirm("Bạn có chắc muốn thay đổi trạng thái của User ID: " + userId + "?")) {
                $.ajax({
                    url: apiBaseUrl + "/api/QLNguoiDung/" + userId + "/SetTrangThai",
                    type: "PUT",
                    headers: getApiHeaders(true),
                    data: JSON.stringify(newStatus), // Gửi 'true' hoặc 'false'
                    success: function() {
                        alert("Cập nhật trạng thái thành công!");
                        loadUsers(); // Tải lại bảng
                    },
                    error: handleApiError
                });
            }
        });

        // === CHẠY KHI TẢI TRANG ===
        if (!token) { /* ... (Copy logic kiểm tra token) ... */ }
        loadUsers();
    });
    </script>
}