@{
    ViewBag.Title = "Admin Dashboard";
}

<h2>Admin Dashboard</h2>
<p>Thống kê tổng quan về hệ thống.</p>
<hr />

<div class="row">
    <div class="col-md-3">
        <div class="panel panel-primary">
            <div class="panel-heading">Tổng Người Dùng</div>
            <div class="panel-body" style="font-size: 24px;">
                <span id="stats-total-users">0</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="panel panel-info">
            <div class="panel-heading">User Mới Hôm Nay</div>
            <div class="panel-body" style="font-size: 24px;">
                <span id="stats-new-users">0</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="panel panel-success">
            <div class="panel-heading">Tổng Câu Hỏi</div>
            <div class="panel-body" style="font-size: 24px;">
                <span id="stats-total-questions">0</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="panel panel-warning">
            <div class="panel-heading">Trận Chơi Hôm Nay</div>
            <div class="panel-body" style="font-size: 24px;">
                <span id="stats-games-today">0</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function () {
        // === KHAI BÁO BIẾN TOÀN CỤC ===
        var apiBaseUrl = "https://localhost:7092"; // Đảm bảo API đang chạy!
        var token = localStorage.getItem("jwtToken");

        // Hàm helper để lấy Headers (dùng cho mọi API Admin)
        function getApiHeaders() {
            return {
                "Authorization": "Bearer " + token
            };
        }

        // Hàm xử lý lỗi chung
        function handleApiError(jqXHR) {
            if (jqXHR.status == 401 || jqXHR.status == 403) {
                // Token hết hạn hoặc không có quyền
                alert("Phiên đăng nhập đã hết hạn hoặc bạn không có quyền. Vui lòng đăng nhập lại.");
                // Xóa token cũ và đá về trang login
                localStorage.removeItem("jwtToken");
                window.location.href = "@Url.Action("Login", "Account")";
            } else {
                alert("Đã xảy ra lỗi: " + (jqXHR.responseJSON?.message || jqXHR.statusText));
            }
        }

        // === GỌI API ĐỂ LẤY DỮ LIỆU ===
        function loadDashboardStats() {
            $.ajax({
                url: apiBaseUrl + "/api/admin/dashboard",
                type: "GET",
                headers: getApiHeaders(),
                success: function (response) {
                    // Đổ dữ liệu vào các thẻ <span>
                    $("#stats-total-users").text(response.tongSoNguoiDung);
                    $("#stats-new-users").text(response.nguoiDungMoiHomNay);
                    $("#stats-total-questions").text(response.tongSoCauHoi);
                    $("#stats-games-today").text(response.soTranDauHomNay);
                },
                error: function (jqXHR) {
                    handleApiError(jqXHR);
                }
            });
        }

        // === CHẠY KHI TẢI TRANG ===
        if (!token) {
            // Nếu không có token, đá về trang Login ngay
            window.location.href = "@Url.Action("Login", "Account")";
            return;
        }

        loadDashboardStats();
    });
    </script>
}