@{
    ViewBag.Title = "Chơi Quiz";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    string roomId = ViewBag.RoomId != null ? ViewBag.RoomId.ToString() : "";
}

<div class="container mt-5" id="game-container">

    <div id="start-screen" class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-gamepad fa-5x text-warning mb-3"></i>
            <h1 class="display-3 fw-black text-uppercase text-primary" style="font-family: 'Orbitron', sans-serif;">
                Đấu Trường Tri Thức
            </h1>
        </div>

        @if (!string.IsNullOrEmpty(roomId))
        {
            <p class="lead mb-2 fs-4 text-success fw-bold">
                Bạn đang tham gia phòng: @roomId
            </p>
        }

        <p class="lead mb-5 fs-4">Bạn đã sẵn sàng chinh phục đỉnh cao chưa?</p>

        <button onclick="startGame()" class="btn btn-danger btn-lg px-5 py-4 rounded-pill shadow-lg hover-scale fw-bold fs-3">
            <i class="fas fa-rocket me-2"></i> CHIẾN THÔI!
        </button>
    </div>

    <div id="play-screen" style="display:none;">
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">

            <div class="card-header bg-gradient bg-dark text-white text-center py-4">
                <span class="badge bg-warning text-dark mb-2">CÂU HỎI</span>
                <h3 class="m-0 fw-bold" id="question-text">Đang tải dữ liệu...</h3>
            </div>

            <div class="card-body p-5 bg-light">
                <div class="row g-4" id="answers-area"></div>
            </div>

            <div class="card-footer bg-dark text-white text-center py-3">
                <small class="text-white-50">
                    Mã lượt chơi:
                    <span id="attempt-id" class="fw-bold text-warning">...</span>
                </small>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>

let currentAttemptId = 0;
let currentQuestionId = 0;

// ===== FIX 1: KHÔNG BAO GIỜ VÒNG LẶP NỮA =====
let isLoadingNext = false;

// ===== START GAME =====
function startGame() {

    const options = {
        ChuDeID: 1,
        DoKhoID: 1,
        SoLuongCauHoi: 10
    };

    $('#start-screen').fadeOut(300, () => $('#play-screen').fadeIn(300));

    $('#question-text').text("Đang khởi tạo bài thi...");

    $.ajax({
        url: '@Url.Action("StartGame", "Play")',
        type: 'POST',
        data: options,
        success: function (res) {

            if (!res || !res.attemptID) {
                alert("Lỗi backend: Không có AttemptID.");
                resetGame();
                return;
            }

            currentAttemptId = res.attemptID;
            $('#attempt-id').text(currentAttemptId);

            if (!res.question) {
                alert("Không nhận được câu hỏi đầu tiên!");
                resetGame();
                return;
            }

            renderQuestion(res.question);
        },
        error: function () {
            alert("Không thể bắt đầu game.");
            resetGame();
        }
    });
}


// ===== HIỂN THỊ CÂU HỎI =====
function renderQuestion(q) {

    if (!q) {
        alert("Dữ liệu câu hỏi trống!");
        return;
    }

    const qId = q.cauHoiID || q.CauHoiID;
    const content = q.noiDung || q.NoiDung;

    const A = q.dapAnA || q.DapAnA;
    const B = q.dapAnB || q.DapAnB;
    const C = q.dapAnC || q.DapAnC;
    const D = q.dapAnD || q.DapAnD;

    if (!qId || !content) {
        alert("Lỗi dữ liệu câu hỏi không hợp lệ!");
        return;
    }

    currentQuestionId = qId;

    $('#question-text').text(content);

    $('#answers-area').html(`
        <div class="col-md-6"><button onclick="submitAnswer('A')" class="btn btn-outline-primary w-100 p-4 fw-bold text-start shadow-sm">A. ${A}</button></div>
        <div class="col-md-6"><button onclick="submitAnswer('B')" class="btn btn-outline-primary w-100 p-4 fw-bold text-start shadow-sm">B. ${B}</button></div>
        <div class="col-md-6"><button onclick="submitAnswer('C')" class="btn btn-outline-primary w-100 p-4 fw-bold text-start shadow-sm">C. ${C}</button></div>
        <div class="col-md-6"><button onclick="submitAnswer('D')" class="btn btn-outline-primary w-100 p-4 fw-bold text-start shadow-sm">D. ${D}</button></div>
    `);
}


// ===== SUBMIT ANSWER =====
function submitAnswer(ans) {

    const data = {
        QuizAttemptID: currentAttemptId,
        CauHoiID: currentQuestionId,
        DapAnDaChon: ans
    };

    $('#answers-area button').prop("disabled", true);

    $.ajax({
        url: '@Url.Action("SubmitAnswer", "Play")',
        type: 'POST',
        data: data,
        success: function () {
            loadNextQuestion();
        },
        error: function () {
            alert("Không thể nộp đáp án.");
            $('#answers-area button').prop("disabled", false);
        }
    });
}


// ===== LOAD NEXT QUESTION =====
function loadNextQuestion() {

    if (isLoadingNext) return;  // FIX vòng lặp vô hạn
    isLoadingNext = true;

    $('#question-text').text("Đang tải câu tiếp theo...");
    $('#answers-area').empty();

    $.ajax({
        url: '@Url.Action("NextQuestion", "Play")',
        type: 'POST',
        data: { attemptId: currentAttemptId },
        success: function (res) {

            isLoadingNext = false;

            if (!res) {
                alert("Không nhận được dữ liệu tiếp theo!");
                return;
            }

            if (res.isFinished === true) {
                alert("Bạn đã hoàn thành bài thi!");
                location.href = '@Url.Action("Index","Home")';
                return;
            }

            if (!res.CauHoiID && !res.cauHoiID) {
                alert("Không có câu hỏi tiếp theo!");
                return;
            }

            renderQuestion(res);
        },
        error: function () {
            isLoadingNext = false;
            alert("Không thể tải câu tiếp theo.");
        }
    });
}

function resetGame() {
    $('#play-screen').hide();
    $('#start-screen').show();
}

    </script>
}
